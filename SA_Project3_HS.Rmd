---
title: "SA_Project3"
author: "Haleigh Schwartz"
date: "2024-04-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Set up
```{r}
library(tidyverse)
library(skimr)
library(survival)
library(survminer)
library(asaur)
library(broom) 
library(car)
library(nlme)
library(fitdistrplus)

setwd("/Users/Haleigh/Documents/MSDS/Survival Analysis/RMDs_and_CSVs")

```

#Read in data, clean
```{r}
#basic cleaning

#initialize empty list
result_list = list()

#set up for loop since doing same thing on all 4 ecosystems
for (i in c("laravel", "npm", "r", "wp")){
  
  #read in data
  meta_i = read_csv(paste("/Users/Haleigh/Documents/MSDS/Survival Analysis/githubSurvival/data/metadata-",i,".csv",sep=""))
  or_i = read_csv(paste("/Users/Haleigh/Documents/MSDS/Survival Analysis/githubSurvival/data/oracle-",i,".csv",sep=""))
  
  #first lowercase the joining columns to make sure they all match
  meta_i = meta_i %>%
  mutate(repo_name = tolower(repo_name))
  or_i = or_i %>%
  mutate(repo = tolower(repo))
  
  #join
  result_list[[i]] = full_join(meta_i, or_i, by=c("repo_name" = "repo"))
  
}

#name individual datasets
lar = result_list[["laravel"]]
npm = result_list[["npm"]]
r = result_list[["r"]]
wp = result_list[["wp"]]

#-------------------

#clean for km curves/modeling 

#add col specifying ecosystem
lar = lar %>%
  mutate(ecosystem = "lar")
npm = npm %>%
  mutate(ecosystem = "npm")
r = r %>%
  mutate(ecosystem = "r")
wp = wp %>%
  mutate(ecosystem = "wp")

#horizontal join them all
ds = lar %>%
  bind_rows(npm) %>%
  bind_rows(r) %>%
  bind_rows(wp)

#check
ds_dim = dim(ds)
lar_dim = dim(lar)
r_dim = dim(r)
wp_dim = dim(wp)
npm_dim = dim(npm)

ds_dim-(lar_dim+r_dim+wp_dim+npm_dim)

#recode status col 
ds = ds %>%
  mutate(status2 = ifelse(status=="Dead",1,0))

#interval times (marked as dead or alive if no activity/activity w/in 6mo), so add time1 and time2
ds=ds %>%
  mutate(
    time1 = as.numeric(ifelse(status2==1, pmax(0.0001, months-6), pmax(0.0001, months))), #can't have time=0
    time2 = as.numeric(ifelse(status2==1,pmax(0.0001, months),Inf)) #can't have time=0
  )

#remove duplicated and/or unnecessary columns
ds=ds %>%
  dplyr::select(-repo_name,-page, -index, -owner, -name, -type)

```

#EDA
```{r}
#switch out ds name
summary(lar)

lar %>%
  ggplot()+
  geom_point(aes(x=months, y=commits, color=status)) +
  labs(title="number of commits over time by status")

lar %>%
  group_by(status) %>%
  summarize(
    mean_commits = mean(commits),
    mean_authors = mean(authors),
    mean_time = mean(months),
    mean_pulls = mean(pulls),
    mean_issues = mean(issues),
    mean_comments = mean(comments),
    mean_reviews = mean(reviews)
  ) %>%
  ggplot()+
  geom_col(aes(x=status, y=mean_commits))

lar %>%
  filter(repoType=="Organization")%>% #change between user and Organization
  group_by(status)%>%
  summarize(
    n = n()
  ) %>%
  ggplot()+
  geom_col(aes(x=status,y=n))

lar %>%
  filter(repoType=="User")%>% #change between user and Organization
  group_by(sizeUsers)%>%
  summarize(
    n=n()
  ) %>%
  ggplot()+
  geom_col(aes(x=sizeUsers, y=n))

```
#Q1: Which ecosystems survived the longest?
```{r}
#km curve
km_eco = survfit(Surv(time=ds$time1, time2=ds$time2, type="interval2")~ds$ecosystem)
#plot
ggsurvplot(
  fit=km_eco,
  data=ds,
  surv.median.line = "hv" 
) + labs(title="Survival probability over time by ecosystem")

#----------------------

#stratify
km_eco_strata = survfit(Surv(time=ds$time1, time2=ds$time2, type="interval2")~ds$ecosystem + strata(ds$repoType))

ggsurvplot(
  fit=km_eco_strata,
  data=ds,
  surv.median.line = "hv" 
)

#----------------------
#----------------------

#fit to model

#----------------------

#first see if weibull would be a good option

#pull out necessary data from km curve
km_basic=survfit(Surv(time=ds$time1, time2=ds$time2, type="interval2")~1)
survProb=km_basic$surv
survTime=km_basic$time

#loglog 
tibble(
logLogSurvProb=log(-log(survProb)),
logSurvTime=log(survTime)) %>%
ggplot(aes(x=logSurvTime,y=logLogSurvProb)) +
  geom_point(color="darkolivegreen") +
  labs(title="Weibull plot: with time=0 (converted to 0.0001)")+
  theme_classic()

#looks okay, find the outlier ~(-2.4,-10)
y <- exp(-exp(-2.4))
print(y) #not an issue
x = exp(-10)
print(x) #this is the problem one, see where survTime~4.539993e-05

survTime#it's the first one, it's because of all the time1=0.0001. see how many rows have months=0, will consider throwing out

ds %>%
  filter(months==0)%>%
  summarize(count=n()) #months=0 97 times, that's almost 10% of ds so can't throw out. look at other models instead

#----------------------

#I feel like parametric should work because of how the km curve looks so try lognormal, exp and compare

#make tibble that works for fitdistcens
interval_ds = ds %>%
  dplyr::select(time1,time2) %>%
  rename(left=time1) %>%
  rename(right=time2)

#make the models. 
lnormFit=fitdistcens(data.frame(interval_ds),distr = "lnorm")
weibullFit=fitdistcens(data.frame(interval_ds),distr = "weibull")
expFit=fitdistcens(data.frame(interval_ds),distr = "exponential")

#couldn't get any to work, probably because of the same reason weibull was a bad fit. will try coxph

#----------------------

#coxph doesn't work with interval censored data
survObject=Surv(time=ds$time1, time2=ds$time2, type="interval2")
coxMod=coxph(survObject~ecosystem, data=ds) 
summary(coxMod) 


#---------------------

#remove where time<1 and try parametric again

#remove problem rows
ds2=ds %>%
  filter(time1>=1, time2>=1)

#see if weibull would be a good fit
km_basic2=survfit(Surv(time=ds2$time1, time2=ds2$time2, type="interval2")~1)
survProb2=km_basic2$surv
survTime2=km_basic2$time

#loglog 
tibble(
logLogSurvProb=log(-log(survProb2)),
logSurvTime=log(survTime2)) %>%
ggplot(aes(x=logSurvTime,y=logLogSurvProb)) +
  geom_point(color="darkolivegreen") +
  labs(title="Weibull plot: without time=0")+
  theme_classic() 

#looks much better, step wise because interval censored

#---------------------

#compare to lnorm and exp

#make tibble that works for fitdistcens
interval_ds2 = ds2 %>%
  dplyr::select(time1,time2) %>%
  rename(left=time1) %>%
  rename(right=time2)

#make the models- still it thinks there are na's? even tried filtering down data to time > 1 and that didn't change anything.
lnormFit=fitdistcens(data.frame(interval_ds2), "lnorm")
weibullFit=fitdistcens(data.frame(interval_ds2),"weibull")
expFit=fitdistcens(data.frame(interval_ds2),"exponential")

interval_ds2 %>% filter(is.na(right))

#---------------------

#try to compare by using survreg and aic

#first weibull - throw everything in and drop as needed
weibull = survreg(Surv(time=ds2$time1, time2=ds2$time2, type="interval2")~ecosystem, data=ds2)

weibull1 = survreg(Surv(time=ds2$time1, time2=ds2$time2, type="interval2")~ecosystem+repoType+sizeUsers+authors+commits+pulls+issues+comments+reviews, data=ds2)
summary(weibull1) 

#drop repoType, issues, comments, and reviews
weibull2 = survreg(Surv(time=ds2$time1, time2=ds2$time2, type="interval2")~ds2$ecosystem+ds2$sizeUsers+ds2$authors+ds2$commits+ds2$pulls, data=ds2)
summary(weibull2) #all are sig

#try with giving different shapes to just the variable in question
weibull3 = survreg(Surv(time=ds2$time1, time2=ds2$time2, type="interval2")~strata(ecosystem)+sizeUsers+authors+commits+pulls, data=ds2)
summary(weibull3)

#compare with aic
AIC(weibull)
AIC(weibull1)
AIC(weibull2) #they are all essentially the same (besides the first), go with simplest one (this one)
AIC(weibull3)


#try other parametric fits with simplest model and compare
lnorm = survreg(Surv(time=ds2$time1, time2=ds2$time2, type="interval2")~ds2$ecosystem+ds2$sizeUsers+ds2$authors+ds2$commits+ds2$pulls, dist = "lognormal", data=ds2)

exp = survreg(Surv(time=ds2$time1, time2=ds2$time2, type="interval2")~ecosystem+sizeUsers+authors+commits+pulls, dist = "exponential", data=ds2)

AIC(weibull2)
AIC(lnorm) #this one is lowest but they're less than 5% different
AIC(exp)

#---------------------

#move forward with lnorm
summary(lnorm) #commits is no longer significant

#redo km object with new ds
km_eco2 = survfit(Surv(time=ds2$time1, time2=ds2$time2, type="interval2")~ds2$ecosystem, data=ds2)

#graph predicted v actual
km_eco_ds=tibble(
  ecosystem=
    rep(
      names(km_eco2$strata),
      times=km_eco2$strata),
    time=km_eco2$time,
    surv=km_eco2$surv) %>%
	mutate(
		ecosystem=str_replace_all(ecosystem,"ds2\\$ecosystem=","")
	)

#find predicted values from simple model
lnorm_pred = predict(lnorm,
        newdata=data.frame(ecosystem=unique(ds2$ecosystem)),
        type="quantile",
        p=seq(0.01,0.99,0.01),
        se.fit=T)

lnorm_pred_fit=tibble(
  quantile=seq(0.01,0.99,0.01),	
  as.data.frame(t(lnorm_pred$fit)))

names(lnorm_pred_fit)=c("p",unique(ds2$ecosystem))

lnorm_pred_fit=lnorm_pred_fit %>%
  dplyr::select(p:wp)

#graph the predicted object
lnorm_pred_fit %>%
	pivot_longer("lar":"wp",names_to="ecosystem",values_to = "deathTime") %>%
	ggplot(aes(x=deathTime,y=rev(p),color=ecosystem)) +
	geom_line(linewidth=1.1) +
	labs(
		title="Survival probability over time per ecosystem",
		x="Time (months)",
		y="Survival probability"
	) +
	theme_minimal() +
	geom_line(data=km_eco_ds,aes(x=time,y=surv), color="black")+
  facet_wrap(ecosystem~.)+
  xlim(0,72) #looks pretty bad


#------------------------

#not sure what else to try. Can’t do non linear modeling (doesn’t fit assumptions), can’t do coxph (coxph doesn’t work with interval censored data), can’t do frailty (doesn’t fit assumptions)

```


#Q2: Which repoType survives the longest?
```{r}

#km curve
km_repo = survfit(Surv(time=ds$time1, time2=ds$time2, type="interval2")~ds$repoType)
#plot
ggsurvplot(
  fit=km_repo,
  data=ds,
  surv.median.line = "hv" 
)

#do modeling later

```

#Q2: Which sizeUsers survives the longest?
```{r}

#km curve
km_size = survfit(Surv(time=ds$time1, time2=ds$time2, type="interval2")~ds$sizeUsers)
#plot
ggsurvplot(
  fit=km_size,
  data=ds,
  surv.median.line = "hv" 
)

#do modeling later

```

Q4: Impact of type of event on survivability?
```{r}
#thought about trying this, but row # would be ~1.25mill and I wasn't sure my computers ram could handle it haha
```
















