---
title: "SA_Project3"
author: "Haleigh Schwartz"
date: "2024-04-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Set up
```{r}
library(tidyverse)
library(skimr)
library(survival)
library(survminer)
library(asaur)
library(broom) 
library(car)
library(nlme)

setwd("/Users/Haleigh/Documents/MSDS/Survival Analysis/RMDs_and_CSVs")

```

#Read in data, clean
```{r}
#basic cleaning

#initialize empty list
result_list = list()

#set up for loop since doing same thing on all 4 ecosystems
for (i in c("laravel", "npm", "r", "wp")){
  
  #read in data
  meta_i = read_csv(paste("/Users/Haleigh/Documents/MSDS/Survival Analysis/githubSurvival/data/metadata-",i,".csv",sep=""))
  or_i = read_csv(paste("/Users/Haleigh/Documents/MSDS/Survival Analysis/githubSurvival/data/oracle-",i,".csv",sep=""))
  
  #first lowercase the joining columns to make sure they all match
  meta_i = meta_i %>%
  mutate(repo_name = tolower(repo_name))
  or_i = or_i %>%
  mutate(repo = tolower(repo))
  
  #join
  result_list[[i]] = full_join(meta_i, or_i, by=c("repo_name" = "repo"))
  
}

#name individual datasets
lar = result_list[["laravel"]]
npm = result_list[["npm"]]
r = result_list[["r"]]
wp = result_list[["wp"]]

#-------------------

#clean for km curves/modeling 

#add col specifying ecosystem
lar = lar %>%
  mutate(ecosystem = "lar")
npm = npm %>%
  mutate(ecosystem = "npm")
r = r %>%
  mutate(ecosystem = "r")
wp = wp %>%
  mutate(ecosystem = "wp")

#horizontal join them all
ds = lar %>%
  bind_rows(npm) %>%
  bind_rows(r) %>%
  bind_rows(wp)

#check
ds_dim = dim(ds)
lar_dim = dim(lar)
r_dim = dim(r)
wp_dim = dim(wp)
npm_dim = dim(npm)

ds_dim-(lar_dim+r_dim+wp_dim+npm_dim)

#recode status col 
ds = ds %>%
  mutate(status2 = ifelse(status=="Dead",1,0))

#interval times (marked as dead or alive if no activity/activity w/in 6mo), so add time1 and time2
ds = ds %>%
  mutate(
    time1 = as.numeric(ifelse(status2==1, pmax(0.0001, months-6), months)),
    time2 = as.numeric(ifelse(status2==1,months,Inf))
  )

```

#EDA
```{r}
#switch out ds name
summary(lar)

lar %>%
  ggplot()+
  geom_point(aes(x=months, y=commits, color=status)) +
  labs(title="number of commits over time by status")

lar %>%
  group_by(status) %>%
  summarize(
    mean_commits = mean(commits),
    mean_authors = mean(authors),
    mean_time = mean(months),
    mean_pulls = mean(pulls),
    mean_issues = mean(issues),
    mean_comments = mean(comments),
    mean_reviews = mean(reviews)
  ) %>%
  ggplot()+
  geom_col(aes(x=status, y=mean_commits))

lar %>%
  filter(repoType=="Organization")%>% #change between user and Organization
  group_by(status)%>%
  summarize(
    n = n()
  ) %>%
  ggplot()+
  geom_col(aes(x=status,y=n))

lar %>%
  filter(repoType=="User")%>% #change between user and Organization
  group_by(sizeUsers)%>%
  summarize(
    n=n()
  ) %>%
  ggplot()+
  geom_col(aes(x=sizeUsers, y=n))

```
#Q1: Which ecosystems survived the longest?
```{r}
#km curve
km_eco = survfit(Surv(time=ds$time1, time2=ds$time2, type="interval2")~ds$ecosystem)
#plot
ggsurvplot(
  fit=km_eco,
  data=ds,
  surv.median.line = "hv" 
)

#stratify
km_eco_strata = survfit(Surv(time=ds$time1, time2=ds$time2, type="interval2")~ds$ecosystem + strata(ds$repoType))

ggsurvplot(
  fit=km_eco_strata,
  data=ds,
  surv.median.line = "hv" 
)


#do modeling later
```


#Q2: Which repoType survives the longest?
```{r}

#km curve
km_repo = survfit(Surv(time=ds$time1, time2=ds$time2, type="interval2")~ds$repoType)
#plot
ggsurvplot(
  fit=km_repo,
  data=ds,
  surv.median.line = "hv" 
)

#do modeling later

```

#Q2: Which sizeUsers survives the longest?
```{r}

#km curve
km_size = survfit(Surv(time=ds$time1, time2=ds$time2, type="interval2")~ds$sizeUsers)
#plot
ggsurvplot(
  fit=km_size,
  data=ds,
  surv.median.line = "hv" 
)

#do modeling later

```

Q4: Impact of type of event on survivability?
```{r}
#thought about trying this, but row # would be ~1.25mill and I wasn't sure my computers ram could handle it haha
```
















